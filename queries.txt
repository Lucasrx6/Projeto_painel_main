WITH parametros AS (
    -- Define per√≠odo de an√°lise
    SELECT 
        TRUNC(SYSDATE) - 1 AS dt_inicio_analise,
        TRUNC(SYSDATE) + 1 AS dt_fim_analise
    FROM DUAL
),
internacoes_base AS (
    -- Base de interna√ß√µes SEM DATA DE ALTA (apenas pacientes internados)
    SELECT DISTINCT
        p.NR_ATENDIMENTO,
        p.DS_CONVENIO,
        p.NM_PACIENTE,
        obter_Idade(p.dt_nascimento, SYSDATE, 'A') AS idade,
        p.DT_ENTRADA,
        p.NM_MEDICO,
        p.dt_nascimento,
        TRUNC(p.DT_ENTRADA) AS dt_internacao,
        NVL(TRUNC(p.dt_alta), TRUNC(SYSDATE) + 1) AS dt_fim_internacao
    FROM paciente_internado_v2 p
    CROSS JOIN parametros par
    WHERE TRUNC(p.DT_ENTRADA) <= par.dt_fim_analise
      AND NVL(TRUNC(p.dt_alta), TRUNC(SYSDATE)) >= par.dt_inicio_analise
      AND p.dt_alta IS NULL  -- ‚úÖ FILTRO ADICIONADO: Apenas pacientes sem alta
),
dados_complementares AS (
    -- Busca dados de setor e unidade (apenas registro mais recente por atendimento)
    SELECT 
        nr_atendimento,
        cd_setor_atendimento,
        cd_unidade,
        nm_guerra,
        dt_entrada_unidade,
        ROW_NUMBER() OVER (PARTITION BY nr_atendimento ORDER BY dt_entrada_unidade DESC) AS rn
    FROM ocupacao_unidade_v
    WHERE nm_pessoa_fisica IS NOT NULL
),
turnos_calendario AS (
    -- Gera todos os dias do per√≠odo
    SELECT 
        par.dt_inicio_analise + LEVEL - 1 AS dt_dia
    FROM parametros par
    CONNECT BY LEVEL <= (par.dt_fim_analise - par.dt_inicio_analise)
),
turnos_completos AS (
    -- Gera turnos DIURNO e NOTURNO
    SELECT 
        dt_dia,
        'DIURNO' AS turno,
        dt_dia + 7/24 AS dt_inicio_turno,
        dt_dia + 19/24 AS dt_fim_turno
    FROM turnos_calendario
    
    UNION ALL
    
    SELECT 
        dt_dia,
        'NOTURNO' AS turno,
        dt_dia + 19/24 AS dt_inicio_turno,
        dt_dia + 1 + 7/24 AS dt_fim_turno
    FROM turnos_calendario
),
internacoes_por_turno AS (
    -- Cruza interna√ß√µes com turnos (apenas onde paciente estava internado)
    SELECT DISTINCT
        i.NR_ATENDIMENTO,
        i.DS_CONVENIO,
        i.NM_PACIENTE,
        i.idade,
        i.DT_ENTRADA,
        i.NM_MEDICO,
        t.dt_dia,
        t.turno,
        t.dt_inicio_turno,
        t.dt_fim_turno,
        TRUNC(t.dt_inicio_turno - i.DT_ENTRADA) AS dias_internado
    FROM internacoes_base i
    CROSS JOIN turnos_completos t
    WHERE t.dt_inicio_turno >= i.DT_ENTRADA
      AND t.dt_inicio_turno < i.dt_fim_internacao
),
evolucoes_por_turno AS (
    SELECT 
        e.nr_atendimento,
        TRUNC(e.dt_evolucao) AS dt_dia,
        CASE 
            WHEN TO_CHAR(e.dt_evolucao, 'HH24:MI') BETWEEN '07:00' AND '18:59' THEN 'DIURNO'
            ELSE 'NOTURNO'
        END AS turno,
        e.ie_tipo_evolucao,
        e.dt_evolucao,
        ROW_NUMBER() OVER (
            PARTITION BY 
                e.nr_atendimento, 
                TRUNC(e.dt_evolucao),
                CASE 
                    WHEN TO_CHAR(e.dt_evolucao, 'HH24:MI') BETWEEN '07:00' AND '18:59' THEN 'DIURNO'
                    ELSE 'NOTURNO'
                END,
                e.ie_tipo_evolucao 
            ORDER BY e.dt_evolucao DESC
        ) AS rn
    FROM EVOLUCAO_PACIENTE e
    WHERE e.ie_tipo_evolucao IN (1, 3, 13, 4, 10)
      AND e.dt_evolucao >= (SELECT dt_inicio_analise FROM parametros)
),
evolucoes_agregadas AS (
    SELECT
        nr_atendimento,
        dt_dia,
        turno,
        MAX(CASE WHEN ie_tipo_evolucao = 1 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_medico,
        MAX(CASE WHEN ie_tipo_evolucao = 3 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_enfermeiro,
        MAX(CASE WHEN ie_tipo_evolucao = 13 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_tec_enfermagem,
        MAX(CASE WHEN ie_tipo_evolucao = 4 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_nutricionista,
        MAX(CASE WHEN ie_tipo_evolucao = 10 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_fisioterapeuta
    FROM evolucoes_por_turno
    WHERE rn = 1
    GROUP BY nr_atendimento, dt_dia, turno
)
SELECT 
    ipt.NR_ATENDIMENTO,
    ipt.DS_CONVENIO,
    ipt.NM_PACIENTE,
    ipt.idade,
    TO_CHAR(ipt.DT_ENTRADA, 'DD/MM/YYYY HH24:MI') AS dt_entrada,
    ipt.NM_MEDICO AS medico_responsavel,
    dc.nm_guerra AS medico_atendimento,
    ipt.dias_internado,
    TO_CHAR(ipt.dt_dia, 'DD/MM/YYYY') AS data_turno,
    ipt.turno,
    SUBSTR(obter_nome_setor(dc.cd_setor_atendimento), 1, 60) AS setor,
    dc.cd_unidade AS unidade,
    TO_CHAR(dc.dt_entrada_unidade, 'DD/MM/YYYY HH24:MI') AS dt_admissao_unidade,
    NVL(ev.evol_medico, 'X') AS evol_medico,
    NVL(ev.evol_enfermeiro, 'X') AS evol_enfermeiro,
    NVL(ev.evol_tec_enfermagem, 'X') AS evol_tec_enfermagem,
    NVL(ev.evol_nutricionista, 'X') AS evol_nutricionista,
    NVL(ev.evol_fisioterapeuta, 'X') AS evol_fisioterapeuta
FROM internacoes_por_turno ipt
LEFT JOIN dados_complementares dc 
    ON ipt.nr_atendimento = dc.nr_atendimento 
    AND dc.rn = 1
LEFT JOIN evolucoes_agregadas ev 
    ON ipt.nr_atendimento = ev.nr_atendimento
    AND ipt.dt_dia = ev.dt_dia
    AND ipt.turno = ev.turno
ORDER BY 
    ipt.dt_dia DESC,
    CASE WHEN ipt.turno = 'DIURNO' THEN 1 ELSE 2 END,
    SUBSTR(obter_nome_setor(dc.cd_setor_atendimento), 1, 60),
    ipt.NM_PACIENTE;







SELECT  B.NM_USUARIO,
        B.NM_MAQ_CLIENTE,
        'Consult√≥rio ' || LPAD(SUBSTR(B.NM_MAQ_CLIENTE, -2), 2, '0') AS CONSULTORIO,
        UPPER(C.DS_USUARIO) AS DS_USUARIO,
        E.ESPECIALIDADE,
        A.MACHINE,
        A.LOGON_TIME,
        TRUNC((SYSDATE - A.LOGON_TIME) * 24) || 'h ' || TRUNC(MOD((SYSDATE - A.LOGON_TIME) * 24 * 60, 60)) || 'min' AS TEMPO_CONECTADO
FROM    usuario_conectado_v A
INNER JOIN TASY_LOG_ACESSO B ON A.MACHINE = B.DS_MAQUINA
INNER JOIN (
    SELECT  DS_MAQUINA,
            MAX(DT_ACESSO) AS MAX_DT_ACESSO
    FROM    TASY_LOG_ACESSO
    GROUP BY DS_MAQUINA
) B_MAX ON B.DS_MAQUINA = B_MAX.DS_MAQUINA 
       AND B.DT_ACESSO = B_MAX.MAX_DT_ACESSO
       AND NM_MAQ_CLIENTE IN (  'FB-D-PS-CONS01',
                                'FB-D-PS-CONS02',
                                'FB-D-PS-CONS03',
                                'FB-D-PS-CONS04',
                                'FB-D-PS-CONS05',
                                'FB-D-PS-CONS06',
                                'FB-D-PS-CONS07',
                                'FB-D-PS-CONS08',
                                'FB-D-PS-CONS09',
                                'FB-D-PS-CONS10')
INNER JOIN USUARIO C ON B.NM_USUARIO = C.NM_USUARIO
LEFT JOIN (
    SELECT  CD_PESSOA_FISICA,
            OBTER_DESC_ESPEC_MEDICA(CD_ESPECIALIDADE) AS ESPECIALIDADE,
            ROW_NUMBER() OVER (PARTITION BY CD_PESSOA_FISICA ORDER BY DT_ATUALIZACAO ASC) AS RN
    FROM    MEDICO_ESPECIALIDADE
) E ON C.CD_PESSOA_FISICA = E.CD_PESSOA_FISICA AND E.RN = 1
ORDER BY NM_MAQ_CLIENTE, A.LOGON_TIME DESC;







select  A.nr_atendimento,
       a.dt_entrada_unidade,
       a.dt_entrada_unid,
       a.cd_unidade,
       a.cd_unidade_basica,
       a.NM_PESSOA_FISICA,
       A.CD_SETOR_ATENDIMENTO,
       obter_nome_setor(a.cd_setor_atendimento),
       A.DT_NASCIMENTO,
       A.IE_SEXO,
       A.DS_CONVENIO,
       A.NR_CRM,
       A.NM_GUERRA,
       A.QT_DIA_PERMANENCIA,
       A.DS_CLINICA,
       A.DT_ALTA_MEDICO,
       a.ds_tipo_acomodacao,
       a.classif,
       a.ie_status_unidade
from ocupacao_unidade_v a,
     UNIDADE_ATENDIMENTO b
where a.cd_setor_atendimento in (41,54,168,184,63,105,78,88,133)
and  a.nr_seq_interno = b.nr_seq_interno
and  b.ie_situacao = 'A';









SELECT 
    a.dt_agenda,
    a.ds_agenda,
    a.cd_agenda,
    CASE 
        WHEN B.NR_SEQ_EVENTO = 12 THEN 'Entrada Paciente CC'
        WHEN B.NR_SEQ_EVENTO = 13 THEN 'Inicio da Cirurgia'
        WHEN B.NR_SEQ_EVENTO = 14 THEN 'Entrada no RPA'
        WHEN B.NR_SEQ_EVENTO = 15 THEN 'S√°ida do RPA'
        WHEN B.NR_SEQ_EVENTO = 16 THEN 'Sadida do CC'
        ELSE 'Sem status'
    END as Evento,
    a.nr_minuto_duracao,
    a.nm_paciente_pf,
    a.ds_convenio,
    a.nm_medico,
    a.ds_idade_abrev,
    obter_unid_setor_cirurgia(a.nr_cirurgia,'S') AS setor_cirurgia,
    substr(nvl(a.nm_instrumentador,nvl(obter_prof_cirurgia_func(a.nr_cirurgia, 'I'),Obter_Prof_Agenda_Cir_Func(a.nr_sequencia, 'I'))),1,255) AS nm_instrumentador,
    substr(nvl(a.nm_circulante,nvl(obter_prof_cirurgia_func(a.nr_cirurgia, 'C'),Obter_Prof_Agenda_Cir_Func(a.nr_sequencia, 'C'))),1,255) AS nm_circulante,
    a.dt_entrada_tasy,
    a.nr_atendimento,
    a.nr_cirurgia,
    a.cd_pessoa_fisica,
    a.nr_sequencia,
    ie_origem_proced,
    a.ie_tipo_classif,
    substr(OBTER_UNIDADE_ATENDIMENTO(a.nr_atendimento,'IA','SU'),1,200) AS unidade_atendimento,
    substr(OBTER_NOME_TIPO_ATEND(OBTER_TIPO_ATENDIMENTO(a.nr_atendimento)),1,255) AS ds_tipo_atendimento,
    to_char(a.hr_inicio,'hh24:mi') AS hr_inicio,
    a.nr_seq_proc_interno,
    substr(obter_se_cirurgia_cancelada(a.nr_cirurgia),1,60) AS ie_cancelada,
    nvl(obter_prescricao_agenda(a.nr_sequencia),obter_prescr_cirurgia(a.nr_cirurgia)) AS nr_prescr_agenda,
    substr(decode('S','S',nvl(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),a.ds_proc_cirurgia),a.ds_proc_cirurgia),1,180) AS ds_proc_cir,
    CAST(substr(obter_status_cirur_paciente(a.nr_cirurgia),1,3) AS INTEGER) AS ie_status_cirurgia,
    OBTER_STATUS_CIRURGIA((obter_status_cirur_paciente(a.nr_cirurgia))) AS ds_status,
    obter_prescr_cirurgia(a.nr_cirurgia) AS nr_prescricao,
    a.ie_tipo_atendimento,
    a.cd_medico,
    a.cd_procedimento,
    a.ds_carater_cirurgia
FROM agenda_paciente_v a
LEFT JOIN (
    SELECT 
        NR_CIRURGIA,
        NR_SEQ_EVENTO,
        DT_REGISTRO,
        ROW_NUMBER() OVER (PARTITION BY NR_CIRURGIA ORDER BY DT_REGISTRO DESC) AS rn
    FROM EVENTO_CIRURGIA_PACIENTE
) B ON A.NR_CIRURGIA = B.NR_CIRURGIA AND B.rn = 1
WHERE a.dt_agenda >= TRUNC(SYSDATE)  
  AND a.dt_agenda < TRUNC(SYSDATE) + 1
  AND a.cd_tipo_agenda = 1 
  AND a.cd_estabelecimento = 1 
  AND (a.ie_status_agenda NOT IN ('L','I','C','B','F') 
       OR (('N' = 'S') AND (a.ie_status_agenda) = 'C' AND (obter_se_cirurgia_cancelada(a.nr_cirurgia) = 'S')) 
       OR ('N' = 'S' AND (a.ie_status_agenda) = 'C')) 
  AND (a.cd_agenda = 0 OR 0 = 0)
ORDER BY a.hr_inicio;











WITH
SV_BASE AS (
    SELECT
        NR_ATENDIMENTO,
        DT_SINAL_VITAL,
        QT_PA_SISTOLICA,
        QT_PA_DIASTOLICA,
        QT_FREQ_CARDIACA,
        QT_FREQ_RESP,
        QT_TEMP,
        QT_SATURACAO_O2,
        QT_PESO,
        QT_IMC,
        QT_GLICEMIA_CAPILAR,
        QT_PAM,
        QT_ESCALA_DOR,
        IE_SITUACAO
    FROM ATENDIMENTO_SINAL_VITAL
    WHERE IE_SITUACAO = 'A'
),
ULT_PA AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PA_SISTOLICA,
            QT_PA_DIASTOLICA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PA_SISTOLICA IS NOT NULL
           OR QT_PA_DIASTOLICA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_CARDIACA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_FREQ_CARDIACA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FR AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_RESP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_FREQ_RESP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_TEMP AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_TEMP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_TEMP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_SAT AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_SATURACAO_O2,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_SATURACAO_O2 IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_PESO AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PESO,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PESO IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_IMC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_IMC,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_IMC IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_GLIC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_GLICEMIA_CAPILAR,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_GLICEMIA_CAPILAR IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_PAM AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PAM,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PAM IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_DOR AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_ESCALA_DOR,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_ESCALA_DOR IS NOT NULL
    ) X
    WHERE rn = 1
),
LAB_BASE AS (
    SELECT
        m.nr_atendimento,
        i.nr_seq_exame,
        p.dt_prev_execucao,
        COALESCE(
            CASE 
                WHEN i.QT_RESULTADO IS NOT NULL 
                     AND TO_NUMBER(i.QT_RESULTADO) != 0 
                THEN TRIM(TO_CHAR(TO_NUMBER(i.QT_RESULTADO), 'FM999999990.999999'))
                ELSE NULL 
            END,
            i.DS_RESULTADO
        ) AS resultado,
        ROW_NUMBER() OVER (
            PARTITION BY m.nr_atendimento, i.nr_seq_exame
            ORDER BY p.dt_prev_execucao DESC, i.nr_seq_resultado DESC
        ) AS rn
    FROM exame_lab_resultado r
    JOIN exame_lab_result_item i 
      ON i.nr_seq_resultado = r.nr_seq_resultado
    JOIN prescr_procedimento p 
      ON r.nr_prescricao = p.nr_prescricao 
     AND i.nr_seq_prescr = p.nr_sequencia
    JOIN exame_laboratorio l 
      ON l.nr_seq_exame = i.nr_seq_exame
    JOIN prescr_medica m 
      ON m.nr_prescricao = p.nr_prescricao
    WHERE p.ie_status_atend > 30
      AND p.dt_prev_execucao >= SYSDATE - 2         -- janelinha de 2 dias (ajust√°vel)
      AND p.ie_suspenso <> 'S'
      AND p.ie_status_execucao <> 'BE'
      AND m.dt_suspensao IS NULL
      AND i.nr_seq_exame IN (
            279, 543, 1435, 423, 536, 913, 1432, 1436, 1438, 1448, 1465,
            1528, 1529, 1531, 1532, 1535, 1548, 1711, 1738, 2000, 2001,
            2247, 2248, 2249, 2250, 2252, 2253, 2255, 2256,
            2258, 2259, 2260, 2261, 2262, 2263, 2264, 2266,
            2551, 3630, 3631, 3634, 3636
      )
      AND (i.QT_RESULTADO IS NOT NULL OR i.DS_RESULTADO IS NOT NULL)
),
LAB_ULTIMO AS (
    SELECT
        nr_atendimento,
        nr_seq_exame,
        resultado
    FROM LAB_BASE
    WHERE rn = 1
),
LAB_PIVOT AS (
    SELECT
        nr_atendimento,
        MAX(CASE WHEN nr_seq_exame = 423  THEN resultado END) AS exm_glicose,
        MAX(CASE WHEN nr_seq_exame = 1438 THEN resultado END) AS exm_creatinina,
        MAX(CASE WHEN nr_seq_exame = 1436 THEN resultado END) AS exm_ureia,
        MAX(CASE WHEN nr_seq_exame = 1528 THEN resultado END) AS exm_sodio,
        MAX(CASE WHEN nr_seq_exame = 1529 THEN resultado END) AS exm_potassio,
        MAX(CASE WHEN nr_seq_exame = 1531 THEN resultado END) AS exm_calcio_ionico,
        MAX(CASE WHEN nr_seq_exame = 1532 THEN resultado END) AS exm_fosforo,
        MAX(CASE WHEN nr_seq_exame = 1465 THEN resultado END) AS exm_magnesio,
        MAX(CASE WHEN nr_seq_exame = 2000 THEN resultado END) AS exm_hematocrito,
        MAX(CASE WHEN nr_seq_exame = 279  THEN resultado END) AS exm_hemoglobina,
        MAX(CASE WHEN nr_seq_exame = 2001 THEN resultado END) AS exm_leucocitos,
        MAX(CASE WHEN nr_seq_exame = 1738 THEN resultado END) AS exm_plaquetas,
        MAX(CASE WHEN nr_seq_exame = 1432 THEN resultado END) AS exm_bilir_total,
        MAX(CASE WHEN nr_seq_exame = 1711 THEN resultado END) AS exm_bilir_indireta,
        MAX(CASE WHEN nr_seq_exame = 2551 THEN resultado END) AS exm_bilir_direta,
        MAX(CASE WHEN nr_seq_exame = 1435 THEN resultado END) AS exm_ggt,
        MAX(CASE WHEN nr_seq_exame = 1448 THEN resultado END) AS exm_rni,
        MAX(CASE WHEN nr_seq_exame = 1535 THEN resultado END) AS exm_troponina,
        MAX(CASE WHEN nr_seq_exame = 1548 THEN resultado END) AS exm_dimero_d,
        MAX(CASE WHEN nr_seq_exame = 3631 THEN resultado END) AS exm_lactato_art,
        MAX(CASE WHEN nr_seq_exame = 3634 THEN resultado END) AS exm_lactato_ven,
        MAX(CASE WHEN nr_seq_exame = 3630 THEN resultado END) AS exm_ca_art,
        MAX(CASE WHEN nr_seq_exame = 3636 THEN resultado END) AS exm_ca_ven,
        MAX(CASE WHEN nr_seq_exame = 2247 THEN resultado END) AS exm_ph_art,
        MAX(CASE WHEN nr_seq_exame = 2248 THEN resultado END) AS exm_pco2_art,
        MAX(CASE WHEN nr_seq_exame = 2249 THEN resultado END) AS exm_po2_art,
        MAX(CASE WHEN nr_seq_exame = 2250 THEN resultado END) AS exm_so2_art,
        MAX(CASE WHEN nr_seq_exame = 2253 THEN resultado END) AS exm_hco3_art,
        MAX(CASE WHEN nr_seq_exame = 2252 THEN resultado END) AS exm_be_art,
        MAX(CASE WHEN nr_seq_exame = 2255 THEN resultado END) AS exm_pao2_art,
        MAX(CASE WHEN nr_seq_exame = 2256 THEN resultado END) AS exm_fio2_art,
        MAX(CASE WHEN nr_seq_exame = 2258 THEN resultado END) AS exm_ph_ven,
        MAX(CASE WHEN nr_seq_exame = 2259 THEN resultado END) AS exm_pco2_ven,
        MAX(CASE WHEN nr_seq_exame = 2260 THEN resultado END) AS exm_po2_ven,
        MAX(CASE WHEN nr_seq_exame = 2261 THEN resultado END) AS exm_so2_ven,
        MAX(CASE WHEN nr_seq_exame = 2264 THEN resultado END) AS exm_hco3_ven,
        MAX(CASE WHEN nr_seq_exame = 2263 THEN resultado END) AS exm_be_ven,
        MAX(CASE WHEN nr_seq_exame = 2262 THEN resultado END) AS exm_ag_ven,
        MAX(CASE WHEN nr_seq_exame = 2266 THEN resultado END) AS exm_pao2_ven

    FROM LAB_ULTIMO
    GROUP BY nr_atendimento
)
SELECT 
    A.nr_atendimento,
    A.dt_entrada_unidade,
    A.dt_entrada_unid,
    A.cd_unidade,
    A.cd_unidade_basica,
    A.NM_PESSOA_FISICA,
    A.CD_SETOR_ATENDIMENTO,
    obter_nome_setor(A.cd_setor_atendimento) AS nm_setor,
    A.DT_NASCIMENTO,
    A.IE_SEXO,
    A.DS_CONVENIO,
    A.NR_CRM,
    A.NM_GUERRA,
    A.QT_DIA_PERMANENCIA,
    A.DS_CLINICA,
    A.DT_ALTA_MEDICO,
    A.ds_tipo_acomodacao,
    A.classif,
    A.ie_status_unidade,
    ULT_PA.QT_PA_SISTOLICA,
    ULT_PA.QT_PA_DIASTOLICA,
    ULT_PAM.QT_PAM,
    ULT_FC.QT_FREQ_CARDIACA,
    ULT_FR.QT_FREQ_RESP,
    ULT_TEMP.QT_TEMP,
    ULT_SAT.QT_SATURACAO_O2,
    ULT_PESO.QT_PESO,
    ULT_IMC.QT_IMC,
    ULT_GLIC.QT_GLICEMIA_CAPILAR,
    ULT_DOR.QT_ESCALA_DOR,
    LAB.exm_glicose,
    LAB.exm_creatinina,
    LAB.exm_ureia,
    LAB.exm_sodio,
    LAB.exm_potassio,
    LAB.exm_calcio_ionico,
    LAB.exm_fosforo,
    LAB.exm_magnesio,
    LAB.exm_hematocrito,
    LAB.exm_hemoglobina,
    LAB.exm_leucocitos,
    LAB.exm_plaquetas,
    LAB.exm_bilir_total,
    LAB.exm_bilir_indireta,
    LAB.exm_bilir_direta,
    LAB.exm_ggt,
    LAB.exm_rni,
    LAB.exm_troponina,
    LAB.exm_dimero_d,
    LAB.exm_lactato_art,
    LAB.exm_lactato_ven,
    LAB.exm_ca_art,
    LAB.exm_ca_ven,
    LAB.exm_ph_art,
    LAB.exm_pco2_art,
    LAB.exm_po2_art,
    LAB.exm_so2_art,
    LAB.exm_hco3_art,
    LAB.exm_be_art,
    LAB.exm_pao2_art,
    LAB.exm_fio2_art,
    LAB.exm_ph_ven,
    LAB.exm_pco2_ven,
    LAB.exm_po2_ven,
    LAB.exm_so2_ven,
    LAB.exm_hco3_ven,
    LAB.exm_be_ven,
    LAB.exm_ag_ven,
    LAB.exm_pao2_ven
FROM ocupacao_unidade_v A
JOIN UNIDADE_ATENDIMENTO B
  ON A.nr_seq_interno = B.nr_seq_interno
LEFT JOIN ULT_PA   ON ULT_PA.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_PAM  ON ULT_PAM.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_FC   ON ULT_FC.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_FR   ON ULT_FR.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_TEMP ON ULT_TEMP.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_SAT  ON ULT_SAT.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_PESO ON ULT_PESO.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_IMC  ON ULT_IMC.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_GLIC ON ULT_GLIC.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_DOR  ON ULT_DOR.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN LAB_PIVOT LAB
  ON LAB.nr_atendimento = A.nr_atendimento
WHERE A.cd_setor_atendimento IN (41,54,168,184,63,105,78,88,133)
AND A.NR_ATENDIMENTO IS NOT NULL
  AND B.ie_situacao = 'A';









WITH
-- ============ TURNO ATUAL DIN√ÇMICO ============
TURNO_ATUAL AS (
    SELECT
        CASE 
            WHEN TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '07:00' AND '18:59' THEN 'DIURNO'
            ELSE 'NOTURNO'
        END AS turno,
        CASE 
            WHEN TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '07:00' AND '18:59' 
            THEN TRUNC(SYSDATE) + 7/24
            ELSE TRUNC(SYSDATE) + 19/24
        END AS dt_inicio_turno,
        CASE 
            WHEN TO_CHAR(SYSDATE, 'HH24:MI') BETWEEN '07:00' AND '18:59' 
            THEN TRUNC(SYSDATE) + 19/24
            ELSE TRUNC(SYSDATE) + 1 + 7/24
        END AS dt_fim_turno
    FROM DUAL
),
-- ============ BASE DE ATENDIMENTOS ATIVOS (FILTRO ANTECIPADO) ============
ATENDIMENTOS_ATIVOS AS (
    SELECT /*+ MATERIALIZE */
        A.nr_atendimento,
        A.nr_seq_interno,
        A.dt_entrada_unidade,
        A.dt_entrada_unid,
        A.cd_unidade,
        A.cd_unidade_basica,
        A.NM_PESSOA_FISICA,
        A.CD_SETOR_ATENDIMENTO,
        A.DT_NASCIMENTO,
        A.IE_SEXO,
        A.DS_CONVENIO,
        A.NR_CRM,
        A.NM_GUERRA,
        A.QT_DIA_PERMANENCIA,
        A.DS_CLINICA,
        A.DT_ALTA_MEDICO,
        A.ds_tipo_acomodacao,
        A.classif,
        A.ie_status_unidade
    FROM ocupacao_unidade_v A
    WHERE A.cd_setor_atendimento IN (41,54,168,184,63,105,78,88,133)
),
ATENDIMENTOS_FILTRADOS AS (
    SELECT /*+ MATERIALIZE */
        AA.*
    FROM ATENDIMENTOS_ATIVOS AA
    JOIN UNIDADE_ATENDIMENTO B
      ON AA.nr_seq_interno = B.nr_seq_interno
    WHERE B.ie_situacao = 'A'
),
-- ============ EVOLU√á√ïES DO TURNO ATUAL (COM FILTRO DE ATENDIMENTOS) ============
EVOLUCOES_AGREGADAS AS (
    SELECT /*+ LEADING(AF t e) USE_HASH(AF e) */
        e.nr_atendimento,
        MAX(CASE WHEN e.ie_tipo_evolucao = 1 THEN 'Feito' END) AS evol_medico,
        MAX(CASE WHEN e.ie_tipo_evolucao = 3 THEN 'Feito' END) AS evol_enfermeiro,
        MAX(CASE WHEN e.ie_tipo_evolucao = 13 THEN 'Feito' END) AS evol_tec_enfermagem,
        MAX(CASE WHEN e.ie_tipo_evolucao = 4 THEN 'Feito' END) AS evol_nutricionista,
        MAX(CASE WHEN e.ie_tipo_evolucao = 10 THEN 'Feito' END) AS evol_fisioterapeuta
    FROM ATENDIMENTOS_FILTRADOS AF
    CROSS JOIN TURNO_ATUAL t
    JOIN EVOLUCAO_PACIENTE e 
      ON e.nr_atendimento = AF.nr_atendimento
     AND e.ie_tipo_evolucao IN (1, 3, 13, 4, 10)
     AND e.dt_evolucao >= t.dt_inicio_turno
     AND e.dt_evolucao < t.dt_fim_turno
    GROUP BY e.nr_atendimento
),
-- ============ PRESCRI√á√ÉO DO DIA (COM FILTRO DE ATENDIMENTOS) ============
PRESCRICAO_DIA AS (
    SELECT /*+ LEADING(AF) USE_HASH(PM) */
        PM.NR_PRESCRICAO,
        PM.NR_ATENDIMENTO,
        OBTER_NOME_PESSOA_FISICA(PM.CD_MEDICO, NULL) AS MEDICO,
        PM.DT_INICIO_PRESCR,
        PM.DT_VALIDADE_PRESCR,
        PM.DT_LIBERACAO_MEDICO,
        ROW_NUMBER() OVER (
            PARTITION BY PM.NR_ATENDIMENTO 
            ORDER BY PM.DT_LIBERACAO_MEDICO DESC
        ) AS rn
    FROM ATENDIMENTOS_FILTRADOS AF
    JOIN PRESCR_MEDICA PM
      ON PM.NR_ATENDIMENTO = AF.nr_atendimento
     AND TRUNC(PM.DT_LIBERACAO_MEDICO) = TRUNC(SYSDATE)
     AND PM.DT_SUSPENSAO IS NULL
     AND OBTER_FUNCAO_USUARIO_ORIG(PM.NM_USUARIO_ORIGINAL) = 'M√©dico'
),
-- ============================================
-- üî¨ NOVA L√ìGICA LAB - 3 ESTADOS
-- ============================================
-- Verifica se h√° PRESCRI√á√ÉO de LAB (qualquer status)
LAB_PRESCRITO AS (
    SELECT /*+ LEADING(AF) USE_HASH(PM PP) */
        PM.NR_PRESCRICAO,
        PM.NR_ATENDIMENTO,
        1 AS HAS_LAB
    FROM ATENDIMENTOS_FILTRADOS AF
    JOIN PRESCR_MEDICA PM
      ON PM.NR_ATENDIMENTO = AF.nr_atendimento
     AND TRUNC(PM.DT_PRESCRICAO) >= TRUNC(SYSDATE)
     AND PM.DT_SUSPENSAO IS NULL
    JOIN PRESCR_PROCEDIMENTO PP
      ON PP.NR_PRESCRICAO = PM.NR_PRESCRICAO
     AND PP.IE_SUSPENSO <> 'S'
     AND PP.IE_STATUS_EXECUCAO <> 'BE'
     AND PP.DT_CANCELAMENTO IS NULL
     AND PP.NR_SEQ_EXAME IS NOT NULL
    GROUP BY PM.NR_PRESCRICAO, PM.NR_ATENDIMENTO
),
-- Verifica se h√° LAB com RESULTADO LIBERADO
LAB_LIBERADO AS (
    SELECT /*+ LEADING(LP) USE_HASH(RL) */
        LP.NR_PRESCRICAO,
        LP.NR_ATENDIMENTO,
        1 AS HAS_RESULT
    FROM LAB_PRESCRITO LP
    JOIN PRESCR_PROCEDIMENTO PP
      ON PP.NR_PRESCRICAO = LP.NR_PRESCRICAO
     AND PP.NR_SEQ_EXAME IS NOT NULL
    JOIN RESULT_LABORATORIO RL
      ON RL.NR_PRESCRICAO = PP.NR_PRESCRICAO
     AND RL.NR_SEQ_PRESCRICAO = PP.NR_SEQUENCIA
     AND RL.DT_COLETA IS NOT NULL
     AND RL.IE_STATUS <> 'I'
    WHERE PP.IE_STATUS_ATEND >= 35
    GROUP BY LP.NR_PRESCRICAO, LP.NR_ATENDIMENTO
),
-- Consolida STATUS LAB por ATENDIMENTO
STATUS_LAB AS (
    SELECT 
        AF.NR_ATENDIMENTO,
        CASE 
            WHEN MAX(LP.HAS_LAB) IS NULL THEN NULL  -- Sem prescri√ß√£o
            WHEN MAX(LL.HAS_RESULT) = 1 THEN 'Sim'  -- Tem resultado liberado
            ELSE 'N√£o'                               -- Prescrito mas pendente
        END AS STATUS_LAB
    FROM ATENDIMENTOS_FILTRADOS AF
    LEFT JOIN LAB_PRESCRITO LP
      ON LP.NR_ATENDIMENTO = AF.NR_ATENDIMENTO
    LEFT JOIN LAB_LIBERADO LL
      ON LL.NR_ATENDIMENTO = AF.NR_ATENDIMENTO
    GROUP BY AF.NR_ATENDIMENTO
),
-- ============================================
-- üè• NOVA L√ìGICA IMAGEM - 3 ESTADOS
-- ============================================
-- Verifica se h√° PRESCRI√á√ÉO de IMAGEM (qualquer status)
IMG_PRESCRITO AS (
    SELECT /*+ LEADING(AF) USE_HASH(PM PP PROC) */
        PM.NR_PRESCRICAO,
        PM.NR_ATENDIMENTO,
        1 AS HAS_IMG
    FROM ATENDIMENTOS_FILTRADOS AF
    JOIN PRESCR_MEDICA PM
      ON PM.NR_ATENDIMENTO = AF.nr_atendimento
     AND TRUNC(PM.DT_PRESCRICAO) >= TRUNC(SYSDATE)
     AND PM.DT_SUSPENSAO IS NULL
     AND (PM.DT_LIBERACAO IS NOT NULL OR PM.DT_LIBERACAO_MEDICO IS NOT NULL)
    JOIN PRESCR_PROCEDIMENTO PP
      ON PP.NR_PRESCRICAO = PM.NR_PRESCRICAO
     AND PP.NR_SEQ_EXAME IS NULL  -- N√ÉO √â EXAME LAB
     AND PP.IE_SUSPENSO <> 'S'
     AND PP.IE_STATUS_EXECUCAO <> 'BE'
    JOIN PROCEDIMENTO PROC
      ON PROC.CD_PROCEDIMENTO = PP.CD_PROCEDIMENTO
     AND PROC.IE_ORIGEM_PROCED = PP.IE_ORIGEM_PROCED
     AND PROC.IE_CLASSIFICACAO = '1'
     AND PROC.CD_TIPO_PROCEDIMENTO IS NOT NULL
    GROUP BY PM.NR_PRESCRICAO, PM.NR_ATENDIMENTO
),
-- Verifica se h√° IMAGEM com LAUDO LIBERADO
IMG_LIBERADO AS (
    SELECT /*+ LEADING(IP) USE_HASH(PP PROC_PAC LP) */
        IP.NR_PRESCRICAO,
        IP.NR_ATENDIMENTO,
        1 AS HAS_LAUDO
    FROM IMG_PRESCRITO IP
    JOIN PRESCR_PROCEDIMENTO PP
      ON PP.NR_PRESCRICAO = IP.NR_PRESCRICAO
     AND PP.NR_SEQ_EXAME IS NULL
    JOIN PROCEDIMENTO_PACIENTE PROC_PAC
      ON PROC_PAC.NR_PRESCRICAO = PP.NR_PRESCRICAO
     AND PROC_PAC.NR_SEQUENCIA_PRESCRICAO = PP.NR_SEQUENCIA
    JOIN LAUDO_PACIENTE LP
      ON LP.NR_SEQ_PROC = PROC_PAC.NR_SEQUENCIA
     AND LP.DT_LIBERACAO IS NOT NULL
    GROUP BY IP.NR_PRESCRICAO, IP.NR_ATENDIMENTO
),
-- Consolida STATUS IMAGEM por ATENDIMENTO
STATUS_IMG AS (
    SELECT 
        AF.NR_ATENDIMENTO,
        CASE 
            WHEN MAX(IP.HAS_IMG) IS NULL THEN NULL  -- Sem prescri√ß√£o
            WHEN MAX(IL.HAS_LAUDO) = 1 THEN 'Sim'   -- Tem laudo liberado
            ELSE 'N√£o'                               -- Prescrito mas pendente
        END AS STATUS_IMG
    FROM ATENDIMENTOS_FILTRADOS AF
    LEFT JOIN IMG_PRESCRITO IP
      ON IP.NR_ATENDIMENTO = AF.NR_ATENDIMENTO
    LEFT JOIN IMG_LIBERADO IL
      ON IL.NR_ATENDIMENTO = AF.NR_ATENDIMENTO
    GROUP BY AF.NR_ATENDIMENTO
),
-- ============ VERIFICA√á√ÉO DE PARECERES PENDENTES (OTIMIZADO) ============
PARECERES_PENDENTES AS (
    SELECT /*+ LEADING(AF) USE_HASH(A B) */
        A.NR_ATENDIMENTO,
        'Sim' AS PARECER_PENDENTE
    FROM ATENDIMENTOS_FILTRADOS AF
    JOIN PARECER_MEDICO_REQ A 
      ON A.NR_ATENDIMENTO = AF.nr_atendimento
     AND A.IE_SITUACAO = 'A'
    LEFT JOIN PARECER_MEDICO B 
      ON A.NR_PARECER = B.NR_PARECER
    WHERE (B.IE_STATUS = 'A' OR B.IE_STATUS IS NULL)
    GROUP BY A.NR_ATENDIMENTO
),
-- ============ VERIFICA√á√ÉO DE ALERGIAS (OTIMIZADO) ============
VERIFICA_ALERGIA AS (
    SELECT /*+ LEADING(AF) USE_HASH(PA) */
        PA.NR_ATENDIMENTO,
        'Sim' AS ALERGIA
    FROM ATENDIMENTOS_FILTRADOS AF
    JOIN PACIENTE_ALERGIA PA
      ON PA.NR_ATENDIMENTO = AF.nr_atendimento
    GROUP BY PA.NR_ATENDIMENTO
),
-- ============================================
-- ‚úÖ SINAIS VITAIS PARA NEWS - CORRIGIDO
-- ============================================
SV_BASE_NEWS AS (
    SELECT
        NR_ATENDIMENTO,
        DT_SINAL_VITAL,
        QT_PA_SISTOLICA,
        QT_FREQ_CARDIACA,
        QT_FREQ_RESP,
        QT_TEMP,
        QT_SATURACAO_O2,
        IE_SITUACAO
    FROM ATENDIMENTO_SINAL_VITAL
    WHERE IE_SITUACAO = 'A'
),
ULT_PA_SIST AS (
    SELECT /*+ MATERIALIZE */ *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PA_SISTOLICA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE_NEWS
        WHERE QT_PA_SISTOLICA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FC_NEWS AS (
    SELECT /*+ MATERIALIZE */ *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_CARDIACA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE_NEWS
        WHERE QT_FREQ_CARDIACA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FR_NEWS AS (
    SELECT /*+ MATERIALIZE */ *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_RESP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE_NEWS
        WHERE QT_FREQ_RESP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_TEMP_NEWS AS (
    SELECT /*+ MATERIALIZE */ *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_TEMP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE_NEWS
        WHERE QT_TEMP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_SAT_NEWS AS (
    SELECT /*+ MATERIALIZE */ *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_SATURACAO_O2,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE_NEWS
        WHERE QT_SATURACAO_O2 IS NOT NULL
    ) X
    WHERE rn = 1
),
-- ============================================
-- üéØ C√ÅLCULO NEWS
-- ============================================
NEWS_CALC AS (
    SELECT
        AF.nr_atendimento,
        NVL(CASE WHEN FR.QT_FREQ_RESP <= 8 THEN 3 WHEN FR.QT_FREQ_RESP BETWEEN 9 AND 11 THEN 1 WHEN FR.QT_FREQ_RESP BETWEEN 12 AND 20 THEN 0 WHEN FR.QT_FREQ_RESP BETWEEN 21 AND 24 THEN 2 WHEN FR.QT_FREQ_RESP >= 25 THEN 3 ELSE 0 END, 0) AS PONTOS_FR,
        NVL(CASE WHEN SAT.QT_SATURACAO_O2 <= 91 THEN 3 WHEN SAT.QT_SATURACAO_O2 BETWEEN 92 AND 93 THEN 2 WHEN SAT.QT_SATURACAO_O2 BETWEEN 94 AND 95 THEN 1 WHEN SAT.QT_SATURACAO_O2 >= 96 THEN 0 ELSE 0 END, 0) AS PONTOS_SAT,
        NVL(CASE WHEN PA.QT_PA_SISTOLICA <= 90 THEN 3 WHEN PA.QT_PA_SISTOLICA BETWEEN 91 AND 100 THEN 2 WHEN PA.QT_PA_SISTOLICA BETWEEN 101 AND 110 THEN 1 WHEN PA.QT_PA_SISTOLICA BETWEEN 111 AND 219 THEN 0 WHEN PA.QT_PA_SISTOLICA >= 220 THEN 3 ELSE 0 END, 0) AS PONTOS_PA,
        NVL(CASE WHEN FC.QT_FREQ_CARDIACA <= 40 THEN 3 WHEN FC.QT_FREQ_CARDIACA BETWEEN 41 AND 50 THEN 1 WHEN FC.QT_FREQ_CARDIACA BETWEEN 51 AND 90 THEN 0 WHEN FC.QT_FREQ_CARDIACA BETWEEN 91 AND 110 THEN 1 WHEN FC.QT_FREQ_CARDIACA BETWEEN 111 AND 130 THEN 2 WHEN FC.QT_FREQ_CARDIACA >= 131 THEN 3 ELSE 0 END, 0) AS PONTOS_FC,
        NVL(CASE WHEN TEMP.QT_TEMP <= 35.0 THEN 3 WHEN TEMP.QT_TEMP BETWEEN 35.1 AND 36.0 THEN 1 WHEN TEMP.QT_TEMP BETWEEN 36.1 AND 38.0 THEN 0 WHEN TEMP.QT_TEMP BETWEEN 38.1 AND 39.0 THEN 1 WHEN TEMP.QT_TEMP >= 39.1 THEN 2 ELSE 0 END, 0) AS PONTOS_TEMP,
        CASE 
            WHEN NVL(CASE WHEN FR.QT_FREQ_RESP <= 8 THEN 3 WHEN FR.QT_FREQ_RESP >= 25 THEN 3 ELSE 0 END, 0) = 3 THEN 1
            WHEN NVL(CASE WHEN SAT.QT_SATURACAO_O2 <= 91 THEN 3 ELSE 0 END, 0) = 3 THEN 1
            WHEN NVL(CASE WHEN PA.QT_PA_SISTOLICA <= 90 THEN 3 WHEN PA.QT_PA_SISTOLICA >= 220 THEN 3 ELSE 0 END, 0) = 3 THEN 1
            WHEN NVL(CASE WHEN FC.QT_FREQ_CARDIACA <= 40 THEN 3 WHEN FC.QT_FREQ_CARDIACA >= 131 THEN 3 ELSE 0 END, 0) = 3 THEN 1
            WHEN NVL(CASE WHEN TEMP.QT_TEMP <= 35.0 THEN 3 ELSE 0 END, 0) = 3 THEN 1
            ELSE 0
        END AS TEM_PARAMETRO_CRITICO
    FROM ATENDIMENTOS_FILTRADOS AF
    LEFT JOIN ULT_PA_SIST PA ON PA.NR_ATENDIMENTO = AF.nr_atendimento
    LEFT JOIN ULT_FC_NEWS FC ON FC.NR_ATENDIMENTO = AF.nr_atendimento
    LEFT JOIN ULT_FR_NEWS FR ON FR.NR_ATENDIMENTO = AF.nr_atendimento
    LEFT JOIN ULT_TEMP_NEWS TEMP ON TEMP.NR_ATENDIMENTO = AF.nr_atendimento
    LEFT JOIN ULT_SAT_NEWS SAT ON SAT.NR_ATENDIMENTO = AF.nr_atendimento
)
-- ============ SELECT PRINCIPAL ============
SELECT 
    AF.nr_atendimento,
    AF.dt_entrada_unidade,
    AF.dt_entrada_unid,
    AF.cd_unidade,
    AF.cd_unidade_basica,
    AF.NM_PESSOA_FISICA,
    C.NR_ANOS,
    AF.CD_SETOR_ATENDIMENTO,
    obter_nome_setor(AF.cd_setor_atendimento) AS nm_setor,
    AF.DT_NASCIMENTO,
    AF.IE_SEXO,
    AF.DS_CONVENIO,
    AF.NR_CRM,
    AF.NM_GUERRA,
    AF.QT_DIA_PERMANENCIA,
    AF.DS_CLINICA,
    AF.DT_ALTA_MEDICO,
    AF.ds_tipo_acomodacao,
    AF.classif,
    AF.ie_status_unidade,
    -- Campos da Prescri√ß√£o
    PD.NR_PRESCRICAO,
    PD.MEDICO,
    PD.DT_INICIO_PRESCR,
    PD.DT_VALIDADE_PRESCR,
    PD.DT_LIBERACAO_MEDICO,
    -- ‚úÖ NOVA L√ìGICA: NULL / N√£o / Sim
    SL.STATUS_LAB AS PRESCRITO_LAB_DIA,
    SI.STATUS_IMG AS PRESCRITO_PROC_DIA,
    -- Evolu√ß√µes do Turno Atual
    NVL(EV.evol_medico, 'X') AS evol_medico,
    NVL(EV.evol_enfermeiro, 'X') AS evol_enfermeiro,
    NVL(EV.evol_tec_enfermagem, 'X') AS evol_tec_enfermagem,
    NVL(EV.evol_nutricionista, 'X') AS evol_nutricionista,
    NVL(EV.evol_fisioterapeuta, 'X') AS evol_fisioterapeuta,
    -- Parecer Pendente
    NVL(PP.PARECER_PENDENTE, 'N√£o') AS PARECER_PENDENTE,
    -- Alergia
    NVL(AL.ALERGIA, 'N√£o') AS ALERGIA,
    -- NEWS SCORE
    NVL(NEWS.PONTOS_FR + NEWS.PONTOS_SAT + NEWS.PONTOS_PA + NEWS.PONTOS_FC + NEWS.PONTOS_TEMP, 0) AS SCORE_NEWS
FROM ATENDIMENTOS_FILTRADOS AF
LEFT JOIN ATENDIMENTO_PACIENTE_V C
  ON C.NR_ATENDIMENTO = AF.nr_atendimento
LEFT JOIN PRESCRICAO_DIA PD
  ON PD.NR_ATENDIMENTO = AF.nr_atendimento
  AND PD.rn = 1
LEFT JOIN STATUS_LAB SL
  ON SL.NR_ATENDIMENTO = AF.nr_atendimento
LEFT JOIN STATUS_IMG SI
  ON SI.NR_ATENDIMENTO = AF.nr_atendimento
LEFT JOIN EVOLUCOES_AGREGADAS EV
  ON EV.nr_atendimento = AF.nr_atendimento
LEFT JOIN PARECERES_PENDENTES PP
  ON PP.NR_ATENDIMENTO = AF.nr_atendimento
LEFT JOIN VERIFICA_ALERGIA AL
  ON AL.NR_ATENDIMENTO = AF.nr_atendimento
LEFT JOIN NEWS_CALC NEWS
  ON NEWS.NR_ATENDIMENTO = AF.nr_atendimento
ORDER BY nm_setor, AF.cd_unidade

-- ============================================
-- üìã INTERPRETA√á√ÉO CL√çNICA DO NEWS
-- ============================================
-- Score 0-4 + SEM par√¢metro=3: Baixo risco
-- Score 5-6 OU QUALQUER par√¢metro=3: M√©dio risco ‚ö†Ô∏è
-- Score ‚â•7: Alto risco üö®
-- ============================================
-- ‚úÖ A regra "par√¢metro=3 ‚Üí M√©dio risco no m√≠nimo"
-- est√° calculada no campo TEM_PARAMETRO_CRITICO
-- Use no frontend para classifica√ß√£o visual!
-- ===========================================+