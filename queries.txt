WITH parametros AS (
    -- Define período de análise
    SELECT 
        TRUNC(SYSDATE) - 1 AS dt_inicio_analise,
        TRUNC(SYSDATE) + 1 AS dt_fim_analise
    FROM DUAL
),
internacoes_base AS (
    -- Base de internações SEM DATA DE ALTA (apenas pacientes internados)
    SELECT DISTINCT
        p.NR_ATENDIMENTO,
        p.DS_CONVENIO,
        p.NM_PACIENTE,
        obter_Idade(p.dt_nascimento, SYSDATE, 'A') AS idade,
        p.DT_ENTRADA,
        p.NM_MEDICO,
        p.dt_nascimento,
        TRUNC(p.DT_ENTRADA) AS dt_internacao,
        NVL(TRUNC(p.dt_alta), TRUNC(SYSDATE) + 1) AS dt_fim_internacao
    FROM paciente_internado_v2 p
    CROSS JOIN parametros par
    WHERE TRUNC(p.DT_ENTRADA) <= par.dt_fim_analise
      AND NVL(TRUNC(p.dt_alta), TRUNC(SYSDATE)) >= par.dt_inicio_analise
      AND p.dt_alta IS NULL  -- ✅ FILTRO ADICIONADO: Apenas pacientes sem alta
),
dados_complementares AS (
    -- Busca dados de setor e unidade (apenas registro mais recente por atendimento)
    SELECT 
        nr_atendimento,
        cd_setor_atendimento,
        cd_unidade,
        nm_guerra,
        dt_entrada_unidade,
        ROW_NUMBER() OVER (PARTITION BY nr_atendimento ORDER BY dt_entrada_unidade DESC) AS rn
    FROM ocupacao_unidade_v
    WHERE nm_pessoa_fisica IS NOT NULL
),
turnos_calendario AS (
    -- Gera todos os dias do período
    SELECT 
        par.dt_inicio_analise + LEVEL - 1 AS dt_dia
    FROM parametros par
    CONNECT BY LEVEL <= (par.dt_fim_analise - par.dt_inicio_analise)
),
turnos_completos AS (
    -- Gera turnos DIURNO e NOTURNO
    SELECT 
        dt_dia,
        'DIURNO' AS turno,
        dt_dia + 7/24 AS dt_inicio_turno,
        dt_dia + 19/24 AS dt_fim_turno
    FROM turnos_calendario
    
    UNION ALL
    
    SELECT 
        dt_dia,
        'NOTURNO' AS turno,
        dt_dia + 19/24 AS dt_inicio_turno,
        dt_dia + 1 + 7/24 AS dt_fim_turno
    FROM turnos_calendario
),
internacoes_por_turno AS (
    -- Cruza internações com turnos (apenas onde paciente estava internado)
    SELECT DISTINCT
        i.NR_ATENDIMENTO,
        i.DS_CONVENIO,
        i.NM_PACIENTE,
        i.idade,
        i.DT_ENTRADA,
        i.NM_MEDICO,
        t.dt_dia,
        t.turno,
        t.dt_inicio_turno,
        t.dt_fim_turno,
        TRUNC(t.dt_inicio_turno - i.DT_ENTRADA) AS dias_internado
    FROM internacoes_base i
    CROSS JOIN turnos_completos t
    WHERE t.dt_inicio_turno >= i.DT_ENTRADA
      AND t.dt_inicio_turno < i.dt_fim_internacao
),
evolucoes_por_turno AS (
    SELECT 
        e.nr_atendimento,
        TRUNC(e.dt_evolucao) AS dt_dia,
        CASE 
            WHEN TO_CHAR(e.dt_evolucao, 'HH24:MI') BETWEEN '07:00' AND '18:59' THEN 'DIURNO'
            ELSE 'NOTURNO'
        END AS turno,
        e.ie_tipo_evolucao,
        e.dt_evolucao,
        ROW_NUMBER() OVER (
            PARTITION BY 
                e.nr_atendimento, 
                TRUNC(e.dt_evolucao),
                CASE 
                    WHEN TO_CHAR(e.dt_evolucao, 'HH24:MI') BETWEEN '07:00' AND '18:59' THEN 'DIURNO'
                    ELSE 'NOTURNO'
                END,
                e.ie_tipo_evolucao 
            ORDER BY e.dt_evolucao DESC
        ) AS rn
    FROM EVOLUCAO_PACIENTE e
    WHERE e.ie_tipo_evolucao IN (1, 3, 13, 4, 10)
      AND e.dt_evolucao >= (SELECT dt_inicio_analise FROM parametros)
),
evolucoes_agregadas AS (
    SELECT
        nr_atendimento,
        dt_dia,
        turno,
        MAX(CASE WHEN ie_tipo_evolucao = 1 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_medico,
        MAX(CASE WHEN ie_tipo_evolucao = 3 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_enfermeiro,
        MAX(CASE WHEN ie_tipo_evolucao = 13 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_tec_enfermagem,
        MAX(CASE WHEN ie_tipo_evolucao = 4 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_nutricionista,
        MAX(CASE WHEN ie_tipo_evolucao = 10 AND rn = 1 THEN 'Feito' ELSE NULL END) AS evol_fisioterapeuta
    FROM evolucoes_por_turno
    WHERE rn = 1
    GROUP BY nr_atendimento, dt_dia, turno
)
SELECT 
    ipt.NR_ATENDIMENTO,
    ipt.DS_CONVENIO,
    ipt.NM_PACIENTE,
    ipt.idade,
    TO_CHAR(ipt.DT_ENTRADA, 'DD/MM/YYYY HH24:MI') AS dt_entrada,
    ipt.NM_MEDICO AS medico_responsavel,
    dc.nm_guerra AS medico_atendimento,
    ipt.dias_internado,
    TO_CHAR(ipt.dt_dia, 'DD/MM/YYYY') AS data_turno,
    ipt.turno,
    SUBSTR(obter_nome_setor(dc.cd_setor_atendimento), 1, 60) AS setor,
    dc.cd_unidade AS unidade,
    TO_CHAR(dc.dt_entrada_unidade, 'DD/MM/YYYY HH24:MI') AS dt_admissao_unidade,
    NVL(ev.evol_medico, 'X') AS evol_medico,
    NVL(ev.evol_enfermeiro, 'X') AS evol_enfermeiro,
    NVL(ev.evol_tec_enfermagem, 'X') AS evol_tec_enfermagem,
    NVL(ev.evol_nutricionista, 'X') AS evol_nutricionista,
    NVL(ev.evol_fisioterapeuta, 'X') AS evol_fisioterapeuta
FROM internacoes_por_turno ipt
LEFT JOIN dados_complementares dc 
    ON ipt.nr_atendimento = dc.nr_atendimento 
    AND dc.rn = 1
LEFT JOIN evolucoes_agregadas ev 
    ON ipt.nr_atendimento = ev.nr_atendimento
    AND ipt.dt_dia = ev.dt_dia
    AND ipt.turno = ev.turno
ORDER BY 
    ipt.dt_dia DESC,
    CASE WHEN ipt.turno = 'DIURNO' THEN 1 ELSE 2 END,
    SUBSTR(obter_nome_setor(dc.cd_setor_atendimento), 1, 60),
    ipt.NM_PACIENTE;







SELECT  B.NM_USUARIO,
        B.NM_MAQ_CLIENTE,
        'Consultório ' || LPAD(SUBSTR(B.NM_MAQ_CLIENTE, -2), 2, '0') AS CONSULTORIO,
        UPPER(C.DS_USUARIO) AS DS_USUARIO,
        E.ESPECIALIDADE,
        A.MACHINE,
        A.LOGON_TIME,
        TRUNC((SYSDATE - A.LOGON_TIME) * 24) || 'h ' || TRUNC(MOD((SYSDATE - A.LOGON_TIME) * 24 * 60, 60)) || 'min' AS TEMPO_CONECTADO
FROM    usuario_conectado_v A
INNER JOIN TASY_LOG_ACESSO B ON A.MACHINE = B.DS_MAQUINA
INNER JOIN (
    SELECT  DS_MAQUINA,
            MAX(DT_ACESSO) AS MAX_DT_ACESSO
    FROM    TASY_LOG_ACESSO
    GROUP BY DS_MAQUINA
) B_MAX ON B.DS_MAQUINA = B_MAX.DS_MAQUINA 
       AND B.DT_ACESSO = B_MAX.MAX_DT_ACESSO
       AND NM_MAQ_CLIENTE IN (  'FB-D-PS-CONS01',
                                'FB-D-PS-CONS02',
                                'FB-D-PS-CONS03',
                                'FB-D-PS-CONS04',
                                'FB-D-PS-CONS05',
                                'FB-D-PS-CONS06',
                                'FB-D-PS-CONS07',
                                'FB-D-PS-CONS08',
                                'FB-D-PS-CONS09',
                                'FB-D-PS-CONS10')
INNER JOIN USUARIO C ON B.NM_USUARIO = C.NM_USUARIO
LEFT JOIN (
    SELECT  CD_PESSOA_FISICA,
            OBTER_DESC_ESPEC_MEDICA(CD_ESPECIALIDADE) AS ESPECIALIDADE,
            ROW_NUMBER() OVER (PARTITION BY CD_PESSOA_FISICA ORDER BY DT_ATUALIZACAO ASC) AS RN
    FROM    MEDICO_ESPECIALIDADE
) E ON C.CD_PESSOA_FISICA = E.CD_PESSOA_FISICA AND E.RN = 1
ORDER BY NM_MAQ_CLIENTE, A.LOGON_TIME DESC;







select  A.nr_atendimento,
       a.dt_entrada_unidade,
       a.dt_entrada_unid,
       a.cd_unidade,
       a.cd_unidade_basica,
       a.NM_PESSOA_FISICA,
       A.CD_SETOR_ATENDIMENTO,
       obter_nome_setor(a.cd_setor_atendimento),
       A.DT_NASCIMENTO,
       A.IE_SEXO,
       A.DS_CONVENIO,
       A.NR_CRM,
       A.NM_GUERRA,
       A.QT_DIA_PERMANENCIA,
       A.DS_CLINICA,
       A.DT_ALTA_MEDICO,
       a.ds_tipo_acomodacao,
       a.classif,
       a.ie_status_unidade
from ocupacao_unidade_v a,
     UNIDADE_ATENDIMENTO b
where a.cd_setor_atendimento in (41,54,168,184,63,105,78,88,133)
and  a.nr_seq_interno = b.nr_seq_interno
and  b.ie_situacao = 'A';









SELECT 
    a.dt_agenda,
    a.ds_agenda,
    a.cd_agenda,
    CASE 
        WHEN B.NR_SEQ_EVENTO = 12 THEN 'Entrada Paciente CC'
        WHEN B.NR_SEQ_EVENTO = 13 THEN 'Inicio da Cirurgia'
        WHEN B.NR_SEQ_EVENTO = 14 THEN 'Entrada no RPA'
        WHEN B.NR_SEQ_EVENTO = 15 THEN 'Sáida do RPA'
        WHEN B.NR_SEQ_EVENTO = 16 THEN 'Sadida do CC'
        ELSE 'Sem status'
    END as Evento,
    a.nr_minuto_duracao,
    a.nm_paciente_pf,
    a.ds_convenio,
    a.nm_medico,
    a.ds_idade_abrev,
    obter_unid_setor_cirurgia(a.nr_cirurgia,'S') AS setor_cirurgia,
    substr(nvl(a.nm_instrumentador,nvl(obter_prof_cirurgia_func(a.nr_cirurgia, 'I'),Obter_Prof_Agenda_Cir_Func(a.nr_sequencia, 'I'))),1,255) AS nm_instrumentador,
    substr(nvl(a.nm_circulante,nvl(obter_prof_cirurgia_func(a.nr_cirurgia, 'C'),Obter_Prof_Agenda_Cir_Func(a.nr_sequencia, 'C'))),1,255) AS nm_circulante,
    a.dt_entrada_tasy,
    a.nr_atendimento,
    a.nr_cirurgia,
    a.cd_pessoa_fisica,
    a.nr_sequencia,
    ie_origem_proced,
    a.ie_tipo_classif,
    substr(OBTER_UNIDADE_ATENDIMENTO(a.nr_atendimento,'IA','SU'),1,200) AS unidade_atendimento,
    substr(OBTER_NOME_TIPO_ATEND(OBTER_TIPO_ATENDIMENTO(a.nr_atendimento)),1,255) AS ds_tipo_atendimento,
    to_char(a.hr_inicio,'hh24:mi') AS hr_inicio,
    a.nr_seq_proc_interno,
    substr(obter_se_cirurgia_cancelada(a.nr_cirurgia),1,60) AS ie_cancelada,
    nvl(obter_prescricao_agenda(a.nr_sequencia),obter_prescr_cirurgia(a.nr_cirurgia)) AS nr_prescr_agenda,
    substr(decode('S','S',nvl(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),a.ds_proc_cirurgia),a.ds_proc_cirurgia),1,180) AS ds_proc_cir,
    CAST(substr(obter_status_cirur_paciente(a.nr_cirurgia),1,3) AS INTEGER) AS ie_status_cirurgia,
    OBTER_STATUS_CIRURGIA((obter_status_cirur_paciente(a.nr_cirurgia))) AS ds_status,
    obter_prescr_cirurgia(a.nr_cirurgia) AS nr_prescricao,
    a.ie_tipo_atendimento,
    a.cd_medico,
    a.cd_procedimento,
    a.ds_carater_cirurgia
FROM agenda_paciente_v a
LEFT JOIN (
    SELECT 
        NR_CIRURGIA,
        NR_SEQ_EVENTO,
        DT_REGISTRO,
        ROW_NUMBER() OVER (PARTITION BY NR_CIRURGIA ORDER BY DT_REGISTRO DESC) AS rn
    FROM EVENTO_CIRURGIA_PACIENTE
) B ON A.NR_CIRURGIA = B.NR_CIRURGIA AND B.rn = 1
WHERE a.dt_agenda >= TRUNC(SYSDATE)  
  AND a.dt_agenda < TRUNC(SYSDATE) + 1
  AND a.cd_tipo_agenda = 1 
  AND a.cd_estabelecimento = 1 
  AND (a.ie_status_agenda NOT IN ('L','I','C','B','F') 
       OR (('N' = 'S') AND (a.ie_status_agenda) = 'C' AND (obter_se_cirurgia_cancelada(a.nr_cirurgia) = 'S')) 
       OR ('N' = 'S' AND (a.ie_status_agenda) = 'C')) 
  AND (a.cd_agenda = 0 OR 0 = 0)
ORDER BY a.hr_inicio;











WITH
SV_BASE AS (
    SELECT
        NR_ATENDIMENTO,
        DT_SINAL_VITAL,
        QT_PA_SISTOLICA,
        QT_PA_DIASTOLICA,
        QT_FREQ_CARDIACA,
        QT_FREQ_RESP,
        QT_TEMP,
        QT_SATURACAO_O2,
        QT_PESO,
        QT_IMC,
        QT_GLICEMIA_CAPILAR,
        QT_PAM,
        QT_ESCALA_DOR,
        IE_SITUACAO
    FROM ATENDIMENTO_SINAL_VITAL
    WHERE IE_SITUACAO = 'A'
),
ULT_PA AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PA_SISTOLICA,
            QT_PA_DIASTOLICA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PA_SISTOLICA IS NOT NULL
           OR QT_PA_DIASTOLICA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_CARDIACA,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_FREQ_CARDIACA IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_FR AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_FREQ_RESP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_FREQ_RESP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_TEMP AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_TEMP,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_TEMP IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_SAT AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_SATURACAO_O2,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_SATURACAO_O2 IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_PESO AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PESO,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PESO IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_IMC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_IMC,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_IMC IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_GLIC AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_GLICEMIA_CAPILAR,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_GLICEMIA_CAPILAR IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_PAM AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_PAM,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_PAM IS NOT NULL
    ) X
    WHERE rn = 1
),
ULT_DOR AS (
    SELECT *
    FROM (
        SELECT
            NR_ATENDIMENTO,
            QT_ESCALA_DOR,
            DT_SINAL_VITAL,
            ROW_NUMBER() OVER (
                PARTITION BY NR_ATENDIMENTO
                ORDER BY DT_SINAL_VITAL DESC
            ) AS rn
        FROM SV_BASE
        WHERE QT_ESCALA_DOR IS NOT NULL
    ) X
    WHERE rn = 1
),
LAB_BASE AS (
    SELECT
        m.nr_atendimento,
        i.nr_seq_exame,
        p.dt_prev_execucao,
        COALESCE(
            CASE 
                WHEN i.QT_RESULTADO IS NOT NULL 
                     AND TO_NUMBER(i.QT_RESULTADO) != 0 
                THEN TRIM(TO_CHAR(TO_NUMBER(i.QT_RESULTADO), 'FM999999990.999999'))
                ELSE NULL 
            END,
            i.DS_RESULTADO
        ) AS resultado,
        ROW_NUMBER() OVER (
            PARTITION BY m.nr_atendimento, i.nr_seq_exame
            ORDER BY p.dt_prev_execucao DESC, i.nr_seq_resultado DESC
        ) AS rn
    FROM exame_lab_resultado r
    JOIN exame_lab_result_item i 
      ON i.nr_seq_resultado = r.nr_seq_resultado
    JOIN prescr_procedimento p 
      ON r.nr_prescricao = p.nr_prescricao 
     AND i.nr_seq_prescr = p.nr_sequencia
    JOIN exame_laboratorio l 
      ON l.nr_seq_exame = i.nr_seq_exame
    JOIN prescr_medica m 
      ON m.nr_prescricao = p.nr_prescricao
    WHERE p.ie_status_atend > 30
      AND p.dt_prev_execucao >= SYSDATE - 2         -- janelinha de 2 dias (ajustável)
      AND p.ie_suspenso <> 'S'
      AND p.ie_status_execucao <> 'BE'
      AND m.dt_suspensao IS NULL
      AND i.nr_seq_exame IN (
            279, 543, 1435, 423, 536, 913, 1432, 1436, 1438, 1448, 1465,
            1528, 1529, 1531, 1532, 1535, 1548, 1711, 1738, 2000, 2001,
            2247, 2248, 2249, 2250, 2252, 2253, 2255, 2256,
            2258, 2259, 2260, 2261, 2262, 2263, 2264, 2266,
            2551, 3630, 3631, 3634, 3636
      )
      AND (i.QT_RESULTADO IS NOT NULL OR i.DS_RESULTADO IS NOT NULL)
),
LAB_ULTIMO AS (
    SELECT
        nr_atendimento,
        nr_seq_exame,
        resultado
    FROM LAB_BASE
    WHERE rn = 1
),
LAB_PIVOT AS (
    SELECT
        nr_atendimento,
        MAX(CASE WHEN nr_seq_exame = 423  THEN resultado END) AS exm_glicose,
        MAX(CASE WHEN nr_seq_exame = 1438 THEN resultado END) AS exm_creatinina,
        MAX(CASE WHEN nr_seq_exame = 1436 THEN resultado END) AS exm_ureia,
        MAX(CASE WHEN nr_seq_exame = 1528 THEN resultado END) AS exm_sodio,
        MAX(CASE WHEN nr_seq_exame = 1529 THEN resultado END) AS exm_potassio,
        MAX(CASE WHEN nr_seq_exame = 1531 THEN resultado END) AS exm_calcio_ionico,
        MAX(CASE WHEN nr_seq_exame = 1532 THEN resultado END) AS exm_fosforo,
        MAX(CASE WHEN nr_seq_exame = 1465 THEN resultado END) AS exm_magnesio,
        MAX(CASE WHEN nr_seq_exame = 2000 THEN resultado END) AS exm_hematocrito,
        MAX(CASE WHEN nr_seq_exame = 279  THEN resultado END) AS exm_hemoglobina,
        MAX(CASE WHEN nr_seq_exame = 2001 THEN resultado END) AS exm_leucocitos,
        MAX(CASE WHEN nr_seq_exame = 1738 THEN resultado END) AS exm_plaquetas,
        MAX(CASE WHEN nr_seq_exame = 1432 THEN resultado END) AS exm_bilir_total,
        MAX(CASE WHEN nr_seq_exame = 1711 THEN resultado END) AS exm_bilir_indireta,
        MAX(CASE WHEN nr_seq_exame = 2551 THEN resultado END) AS exm_bilir_direta,
        MAX(CASE WHEN nr_seq_exame = 1435 THEN resultado END) AS exm_ggt,
        MAX(CASE WHEN nr_seq_exame = 1448 THEN resultado END) AS exm_rni,
        MAX(CASE WHEN nr_seq_exame = 1535 THEN resultado END) AS exm_troponina,
        MAX(CASE WHEN nr_seq_exame = 1548 THEN resultado END) AS exm_dimero_d,
        MAX(CASE WHEN nr_seq_exame = 3631 THEN resultado END) AS exm_lactato_art,
        MAX(CASE WHEN nr_seq_exame = 3634 THEN resultado END) AS exm_lactato_ven,
        MAX(CASE WHEN nr_seq_exame = 3630 THEN resultado END) AS exm_ca_art,
        MAX(CASE WHEN nr_seq_exame = 3636 THEN resultado END) AS exm_ca_ven,
        MAX(CASE WHEN nr_seq_exame = 2247 THEN resultado END) AS exm_ph_art,
        MAX(CASE WHEN nr_seq_exame = 2248 THEN resultado END) AS exm_pco2_art,
        MAX(CASE WHEN nr_seq_exame = 2249 THEN resultado END) AS exm_po2_art,
        MAX(CASE WHEN nr_seq_exame = 2250 THEN resultado END) AS exm_so2_art,
        MAX(CASE WHEN nr_seq_exame = 2253 THEN resultado END) AS exm_hco3_art,
        MAX(CASE WHEN nr_seq_exame = 2252 THEN resultado END) AS exm_be_art,
        MAX(CASE WHEN nr_seq_exame = 2255 THEN resultado END) AS exm_pao2_art,
        MAX(CASE WHEN nr_seq_exame = 2256 THEN resultado END) AS exm_fio2_art,
        MAX(CASE WHEN nr_seq_exame = 2258 THEN resultado END) AS exm_ph_ven,
        MAX(CASE WHEN nr_seq_exame = 2259 THEN resultado END) AS exm_pco2_ven,
        MAX(CASE WHEN nr_seq_exame = 2260 THEN resultado END) AS exm_po2_ven,
        MAX(CASE WHEN nr_seq_exame = 2261 THEN resultado END) AS exm_so2_ven,
        MAX(CASE WHEN nr_seq_exame = 2264 THEN resultado END) AS exm_hco3_ven,
        MAX(CASE WHEN nr_seq_exame = 2263 THEN resultado END) AS exm_be_ven,
        MAX(CASE WHEN nr_seq_exame = 2262 THEN resultado END) AS exm_ag_ven,
        MAX(CASE WHEN nr_seq_exame = 2266 THEN resultado END) AS exm_pao2_ven

    FROM LAB_ULTIMO
    GROUP BY nr_atendimento
)
SELECT 
    A.nr_atendimento,
    A.dt_entrada_unidade,
    A.dt_entrada_unid,
    A.cd_unidade,
    A.cd_unidade_basica,
    A.NM_PESSOA_FISICA,
    A.CD_SETOR_ATENDIMENTO,
    obter_nome_setor(A.cd_setor_atendimento) AS nm_setor,
    A.DT_NASCIMENTO,
    A.IE_SEXO,
    A.DS_CONVENIO,
    A.NR_CRM,
    A.NM_GUERRA,
    A.QT_DIA_PERMANENCIA,
    A.DS_CLINICA,
    A.DT_ALTA_MEDICO,
    A.ds_tipo_acomodacao,
    A.classif,
    A.ie_status_unidade,
    ULT_PA.QT_PA_SISTOLICA,
    ULT_PA.QT_PA_DIASTOLICA,
    ULT_PAM.QT_PAM,
    ULT_FC.QT_FREQ_CARDIACA,
    ULT_FR.QT_FREQ_RESP,
    ULT_TEMP.QT_TEMP,
    ULT_SAT.QT_SATURACAO_O2,
    ULT_PESO.QT_PESO,
    ULT_IMC.QT_IMC,
    ULT_GLIC.QT_GLICEMIA_CAPILAR,
    ULT_DOR.QT_ESCALA_DOR,
    LAB.exm_glicose,
    LAB.exm_creatinina,
    LAB.exm_ureia,
    LAB.exm_sodio,
    LAB.exm_potassio,
    LAB.exm_calcio_ionico,
    LAB.exm_fosforo,
    LAB.exm_magnesio,
    LAB.exm_hematocrito,
    LAB.exm_hemoglobina,
    LAB.exm_leucocitos,
    LAB.exm_plaquetas,
    LAB.exm_bilir_total,
    LAB.exm_bilir_indireta,
    LAB.exm_bilir_direta,
    LAB.exm_ggt,
    LAB.exm_rni,
    LAB.exm_troponina,
    LAB.exm_dimero_d,
    LAB.exm_lactato_art,
    LAB.exm_lactato_ven,
    LAB.exm_ca_art,
    LAB.exm_ca_ven,
    LAB.exm_ph_art,
    LAB.exm_pco2_art,
    LAB.exm_po2_art,
    LAB.exm_so2_art,
    LAB.exm_hco3_art,
    LAB.exm_be_art,
    LAB.exm_pao2_art,
    LAB.exm_fio2_art,
    LAB.exm_ph_ven,
    LAB.exm_pco2_ven,
    LAB.exm_po2_ven,
    LAB.exm_so2_ven,
    LAB.exm_hco3_ven,
    LAB.exm_be_ven,
    LAB.exm_ag_ven,
    LAB.exm_pao2_ven
FROM ocupacao_unidade_v A
JOIN UNIDADE_ATENDIMENTO B
  ON A.nr_seq_interno = B.nr_seq_interno
LEFT JOIN ULT_PA   ON ULT_PA.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_PAM  ON ULT_PAM.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_FC   ON ULT_FC.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_FR   ON ULT_FR.NR_ATENDIMENTO   = A.NR_ATENDIMENTO
LEFT JOIN ULT_TEMP ON ULT_TEMP.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_SAT  ON ULT_SAT.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_PESO ON ULT_PESO.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_IMC  ON ULT_IMC.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN ULT_GLIC ON ULT_GLIC.NR_ATENDIMENTO = A.NR_ATENDIMENTO
LEFT JOIN ULT_DOR  ON ULT_DOR.NR_ATENDIMENTO  = A.NR_ATENDIMENTO
LEFT JOIN LAB_PIVOT LAB
  ON LAB.nr_atendimento = A.nr_atendimento
WHERE A.cd_setor_atendimento IN (41,54,168,184,63,105,78,88,133)
AND A.NR_ATENDIMENTO IS NOT NULL
  AND B.ie_situacao = 'A';


